Pkcs 11 CTIL facts and notes:


10/15/03 RWC Notes
On some PKCS11 interfaces, it is not possible to RSA KTRI encrypt.  If you use the sm_free3 CTIL, it will not be possible to set the "m_bAddOriginatorAsRecipient" flag and expect the certificate to be extracted; this must be done manually by the user.

This CTIL dynamically links to any PKCS11 library, available as a .dll (MS Windows) or .so (Unix/Linux platforms).  We have tested with the libraries listed below; others may require some integration.

Test environment :

	- All the test drivers are named auto_P11ProductName.cfg (i.e. auto_P11DataKey.cfg)

	- The test environment resides in test/sm_pkcs11.

        - The test environment depends on the appropriate DLLs to reside in the SMPDist 
          directory under Algs/pkcs11.  Following are the DLLs that have been tested:

             SMPDist/Algs/pkcs11/dataKey/dkck232n.dll 
             SMPDist/Algs/pkcs11/gemPlus/pk2priv.dll 
             SMPDist/Algs/pkcs11/maestro/mstrcsp.dll 
             SMPDist/Algs/pkcs11/spex/Spex32.dll 

Error handling :

	- Error handling needs to be modified to perform SME_THROW if unable to  :
		- Load Pkcs11 dll
		- Initialize token
		- Login
		- and possibly others 

Integrations :

   pkcs11_cryptopp -
	- NEWLY added smp/pkcs11_cryptopp PKCS11 shared object that uses the Crypto++
	  library.  It performs basic hash and verification operations for RSA/DSA.
	  This library may be improved in the future.  It is the default library used
	  by the CML.

   Maestro - 
	- Maestro integration was successfully performed with Release 1.0 dated 6.30.00.  
	  This integration was performed when the Pkcs11 CTIL staticly linked 
	  to the pkcs11 library listed in the project settings.  The CTIL has been changed 
	  to dynamically load a pkcs11 dll (specified through the Logins) and then request 
	  pointers to all available Pkcs11 functions. After this change (and several others)
	  Maestro integration fails.   Waiting for a new release.

          The Maestro .dll name is "mstrcsp.dll".  They can be contacted at 
          www.sspsolutions.com (under the litronic/maestro links).

   DataKey - installed according to directions that came with the hardward smartcard reader.
             Used verisign to establish certificates on the smartcard.

	- Able to Sign/Verify and generate Enveloped Data (Wrap/Unwrap) using SmartCard 
	  DataKey CIP 
		- Certificate/Private key loaded using Verisign (as per instructions in
		  booklet provided with DataKey package).
		- In order to be able to do ContentEncryption the Logins must include
		  RSA or Free3 (or use sm_pkcs11Free3DLL - Pkcs11 and Free3 "hybrid" dll)

	DataKey can be reached at:  support@datakey.com; 1-888-DATAKEY 

        Datakey, Inc. 
        407 West Travelers Trail 
        Minneapolis, MN 55337-2558 
        Attn: CIP Technical Support 

   GemPlus - On babylon5 (Rich's) directory unzipped the Win9xnt4 to my vdasnacc.d/drivers
             directory. There you will find a gemPlus/Win9xnt4 directory.  I ran the setup 
             executable for GemPlus to install it.

	- Able to Sign and  (Unwrap an enveloped data generated by using BSAFE) using GemPlus
                - GemPlus card didn't support keyWrap or signature verification or 
                  content encryption.  
		- In order to be able to do ContentEncryption the Logins must include
		  RSA or Free3 (or use sm_pkcs11Free3DLL - Pkcs11 and Free3 "hybrid" dll)
		- Cerificate/Private key generated by Rich Nicholas

        The GemPlus name is "pk2priv.dll".  They can be contacted at www.gemplus.com.

   SPEX/2 - Tried to install from SPEX/2 Software Development Kit cd and never had a 
            successful installation.   All pcmcia (Fortezza) and smartcard (GemPlus) reader
            drivers were uninstalled from the system.  Drivers for an ISA internal hardware
            reader were installed on the Windows NT platform.  The configuration process 
            was able to see that there were 2 sockets in the card reader.  The card utility
            test could not see that there were cards in either socket in the card reader.  
            It was determined that the spryus isa drivers were incompatible with the older 
            internal card reader's hardware. Decided to test on SPEXTER in Pierce's office. 
            Installed the spex/2 software on SPEXTER using Pierce's suggested setup. 
            The bottom slot (2) is the only one that works with the lynxs32.dll.  The system
            must be loaded with win NT and log in as Administrator.  At this point the 
            lynxtests can't recognize that there are cards in the slots.  Gave up on that 
            system.  It was determined that we need a dedicated system for each card reader.

            Set up a system in my office for SPEX card reader testing only. Testing 
            with the ftzapk11.dll produces errors with opening a session in read/write mode.
            I have been able to open a session in read only mode. Right now the application 
            can't get a slot list.  The list count is returned as 0, but there 
            is a token with certificates in the slot.  Sent e-mail to tec support at Spyrus
            on Friday March 9, 2001.

            The .dll file is named "Spex32.dll".  They can be contacted at http://www.spyrus.com/            
  
Pkcs11 login line items :

	- Pkcs11 CTIL login entry example:

					Slot# UserPin Pkcs11-dll-name
		- BuildArgs=sm_pkcs11DLL 1    1234    dkck232n.dll

			Slot# 	- is the slot where the token can be found (I found that it is
				  sometimes 0 based and sometimes 1 based.  Variations with
				  platforms (i.e. in Win98 DataKey expected Slot 1 but in 
				  WinNT it expected Slot 2) and variations with Token 
				  Manufacturer (i.e. Gemplus expected 0 but DataKey 
				  expected 1)
			UserPin - User pin for the token
			Pkcs11-dll-name - Name of the dll that provides the Pkcs11 interface
					  to the token.  It currently uses the PATH to find
					  it.

			NOTE : the Pkcs11-dll-name is also used in the CreateInstance method
					      of CSM_Pkcs11 to generate a unique Instance id
					      for every cert/Private key found in the card.
					      It is also used to generate a filename when
					      the 
					      